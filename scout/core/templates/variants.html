{% extends 'layouts/scroll-header.html' %}
{% from '_macros.html' import compounds_table %}

{% set page_title = 'Variants' %}

{% block toolbar_left %}
  {{ super() }}

  <div class="md-breadcrumb-group flex">
    <a class="md-breadcrumb-button is-raised"
       href="{{ url_for('core.cases', institute_id=institute_id) }}">
      {{ institute.display_name }}
    </a>
    <core-icon
      class="md-breadcrumb-separator"
      icon="chevron-right">
    </core-icon>

    <a class="md-breadcrumb-button is-raised" href="{{ url_for('core.case', institute_id=institute_id, case_id=case_id) }}">
      {{ case.display_name }}
    </a>
    <core-icon
      class="md-breadcrumb-separator"
      icon="chevron-right">
    </core-icon>

    <div class="md-breadcrumb">Variants</div>
  </div>
{% endblock %}

{% block toolbar_right %}
  {{ super() }}

  <div v-on="click: showFilters" class="icon-button">
    <core-icon icon="filter-list"></core-icon>
  </div>
{% endblock %}

{% block toolbar_custom %}
  <div class="variants-header">

    <div class="variants-header-item" title="Rank position">Rank</div>
    <div class="variants-header-item" title="Rank score">Score</div>
    <div class="variants-header-item" title="Chromosome">Chr.</div>
    <div class="variants-header-item flex-big" title="HGNC">HGNC</div>
    <div class="variants-header-item" title="1000 Genomes">1000 Genomes</div>
    <div class="variants-header-item" title="CADD score">CADD score</div>
    <div class="variants-header-item" title="Gene annotation">
      Gene annotation
    </div>
    <div class="variants-header-item flex-big" title="Func. annotation">
      Func. annotation
    </div>
    <div class="variants-header-item flex-big" title="Disease group">
      Disease group
    </div>
    <div class="variants-header-item" title="Disease gene model">
      Disease gene model
    </div>
    <div class="variants-header-item flex-big" title="Inheritance models">
      Inheritance models
    </div>

  </div>
{% endblock %}

{% block content %}

  <drawer-panel v-ref="filters" side="right">
    <form method="GET">
      {{ form.csrf_token }}

      <div class="variants-filters-group">
      <div class="variants-filters-group-label">Filters</div>

        <div class="variants-filters-group-list">
          <div class="list-item">
            <div>{{ form.gene_list.label }}</div>
            <div>{{ form.gene_list }}</div>
          </div>

          <div class="list-item">
            <div>{{ form.hgnc_symbol.label }}</div>
            <div>{{ form.hgnc_symbol }}</div>
          </div>
        </div>
      </div>

      <div class="variants-filters-group">
        <div class="variants-filters-group-label">Frequency cutoffs</div>

        <div class="variants-filters-group-list">
          <div class="list-item">
            <div>{{ form.thousand_genomes_frequency.label }}</div>
            <div>{{ form.thousand_genomes_frequency }}</div>
          </div>

          <div class="list-item">
            <div>{{ form.exac_frequency.label }}</div>
            <div>{{ form.exac_frequency }}</div>
          </div>

          <div class="list-item">
            <div>{{ form.local_frequency.label }}</div>
            <div>{{ form.local_frequency }}</div>
          </div>
        </div>
      </div>

      <div class="variants-filters-group">
        <div class="variants-filters-group-label">
          {{ form.region_annotations.label }}
        </div>

        <div class="variant-filters-group-body">
          {{ form.region_annotations(class="variants-filters-select") }}
        </div>
      </div>

      <div class="variants-filters-group">
        <div class="variants-filters-group-label">
          {{ form.functional_annotations.label }}
        </div>

        <div class="variant-filters-group-body">
          {{ form.functional_annotations(class="variants-filters-select") }}
        </div>
      </div>

      <div class="variants-filters-group">
        <div class="variants-filters-group-label">
          {{ form.genetic_models.label }}
        </div>

        <div class="variant-filters-group-body">
          {{ form.genetic_models(class="variants-filters-select") }}
        </div>
      </div>

      <button class="variants-filters-submit" type="submit">
        Filter variants
      </button>
    </form>
  </drawer-panel>

	<div class="variants-body">
		{% for variant in variants %}

      {% set specific = variant.specific[case.case_id] %}

			<div class="variants-row">

        <!-- Rank position -->
				<a class="variants-row-item text-right"
					 href="{{ url_for('core.variant',
                            institute_id=institute_id,
					 									variant_id=variant.variant_id,
                            case_id=case_id) }}">
          {{ specific.variant_rank }}
				</a>

        <!-- Rank score -->
        <div class="variants-row-item text-right">
          {{ specific.rank_score }}
        </div>

        <!-- Chromosome -->
        <div class="variants-row-item">
          {{ variant.chromosome }}
        </div>

        <!-- HGNC -->
				<div class="variants-row-item flex-big">
					{{ (variant.common.hgnc_symbols or ['-'])|join(', ') }}
				</div>

        <!-- 1000 Genomes -->
				<div class="variants-row-item text-right md-tooltip">
          {% if variant.common.thousand_genomes_frequency %}
            {{ variant.common.thousand_genomes_frequency|float|round(3) }}
          {% else %}
            -
          {% endif %}

          <div class="md-tooltip-tip is-left">
            <ul>
              <li><strong>ExAC</strong> {{ variant.common.exac_frequency or '-' }}</li>
              <li><strong>Local</strong> {{ 'soon' }}</li>
            </ul>
          </div>
        </div>

        <!-- CADD (severity) -->
        <div class="variants-row-item text-right md-tooltip">
          {{ variant.common.cadd_score or '-' }}

          <div class="md-tooltip-tip is-right">
            <ul>
              <li>
                <strong>Sift</strong>
                {{ (variant.common.sift_predictions or ['-'])|join(',') }}
              </li>
              <li>
                <strong>PolyPhen</strong>
                {{ (variant.common.polyphen_predictions or ['-'])|join(',') }}
              </li>
            </ul>
          </div>
        </div>

        <!-- Gene annotation -->
        <div class="variants-row-item is-scrollable">
          {{ variant.common.region_annotation|join(',') }}
        </div>

        <!-- Func. annotation -->
        <div class="variants-row-item is-scrollable flex-big">
          {{ variant.common.functional_annotation|join(',') }}
        </div>

        <!-- Disease group -->
        <div class="variants-row-item flex-big">{{ 'coming soon' }}</div>

        <!-- Disease gene model -->
        <div class="variants-row-item">{{ 'coming soon' }}</div>

        <!-- Inheritance models -->
				<div class="variants-row-list flex-big md-tooltip">
          <div class="list--horizontal">
            {% for model in (specific.genetic_models or []) %}
              <div class="variants-row-list-item">{{ model }}</div>
            {% endfor %}
          </div>

          {% if specific.compounds %}
            <div class="md-tooltip-tip is-left">
              {{ compounds_table(
                   specific.compounds,
                   institute_id,
                   case_id,
                   class_names=['default-table', 'table-compounds-popup']) }}
            </div>
          {% endif %}
				</div>

			</div>
		{% endfor %}

	</div>

  {% set get_args = request.args.to_dict() %}
  {{ get_args.update({'skip': current_batch})|default('', True) }}
  <a href="{{ url_for('core.variants', institute_id=institute_id,
                      case_id=case_id, **get_args) }}"
     class="variants-load-more is-raised">
    Load more
  </a>

{% endblock %}
