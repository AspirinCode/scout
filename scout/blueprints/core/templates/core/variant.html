{% extends "core/layout.html" %}
{% from "core/utils.html" import comments_panel, compounds_table, activity_panel %}

{% block top_nav %}
  <li>
    <a href="{{ url_for('core.cases', institute_id=institute_id) }}">
      {{ institute.display_name }}
    </a>
  </li>
  <li>
    <a href="{{ url_for('core.case', institute_id=institute_id, case_id=case_id) }}">
      {{ case.display_name }}
    </a>
  </li>
  <li>
    <a href="{{ url_for('core.variants', institute_id=institute_id, case_id=case_id, variant_type=variant.variant_type, gene_lists=case.default_panels) }}">
      {{ variant.variant_type|capitalize }} variants
    </a>
  </li>
  <li class="active">
    <p class="navbar-text">{{ variant.display_name|truncate(20, True) }}</p>
  </li>
{% endblock %}

{% block top_nav_right %}
  <li>{{ sanger_button() }}</li>
  <li>{{ pin_button() }}</li>
  <li>{{ causative_button() }}</li>

  {{ super() }}
{% endblock %}

{% block content_main %}
  <div class="row">
    <div class="col-xs-12">

    </div>
  </div>
  <div class="row">
    <div class="col-xs-12">{{ matching_variants() }}</div>
  </div>
  <div class="row">
    <div class="col-xs-4">{{ panel_basics() }}</div>
    <div class="col-xs-4">{{ panel_summary() }}</div>
    <div class="col-xs-4">{{ transcript_overview() }}</div>
  </div>
  <div class="row">
    <div class="col-xs-3">{{ frequency_list() }}</div>
    <div class="col-xs-3">{{ severity_list() }}</div>
    <div class="col-xs-3">{{ inheritance_panel() }}</div>
    <div class="col-xs-3">{{ omim_phenotypes() }}</div>
  </div>
  <div class="row">
    <div class="col-xs-4">{{ comments_panel(institute, case, current_user, comments|reverse, variant_id=variant_id) }}</div>
    <div class="col-xs-5">{{ gtcall_panel() }}</div>
    <div class="col-xs-3">{{ pedigree_panel() }}</div>
  </div>
  {% if variant.has_compounds %}
    <div class="row">
      <div class="col-xs-12">{{ compounds_panel() }}</div>
    </div>
  {% endif %}
  <div class="row">
    <div class="col-xs-12">{{ rankscore_panel() }}</div>
  </div>
  <div class="row">
    <div class="col-xs-12">{{ overlapping_svs() }}</div>
  </div>
  <div class="row">
    <div class="col-xs-12">
      <ul class="nav nav-tabs nav-justified">
        <li class="active"><a href="#genes" data-toggle="tab">Genes</a></li>
        <li><a href="#transcripts" data-toggle="tab">Transcripts</a></li>
        <li><a href="#proteins" data-toggle="tab">Proteins</a></li>
      </ul>
      <div class="tab-content">
        <div class="tab-pane fade in active" id="genes">{{ genes_panel() }}</div>
        <div class="tab-pane fade" id="transcripts">{{ transcripts_panel() }}</div>
        <div class="tab-pane fade" id="proteins">{{ proteins_panel() }}</div>
      </div>
    </div>
  </div>
  <div class="row">
    <div class="col-xs-12">{{ external_links() }}</div>
  </div>
  <div class="row">
    <div class="col-xs-12">{{ activity_panel(events|reverse) }}</div>
  </div>

  {{ modal_sanger() }}
{% endblock %}

{% macro sanger_button() %}
  {% if variant.ordered_sanger %}
    {% if variant.validation %}
      <p class="navbar-text">Sanger: {{ variant.validation }}</p>
    {% else %}
      <p class="navbar-text">Sanger pending...</p>
    {% endif %}
  {% else %}
    <button class="btn btn-default navbar-btn" data-toggle="modal" data-target="#sangerModal">
      Sanger
    </button>
  {% endif %}
{% endmacro %}

{% macro sanger_form() %}
  <ul class="list-group">
    <li class="list-group-item">
      <strong>Case {{ case_id }}</strong>:
      <a href="{{ url_for('core.variant',
                          institute_id=institute_id,
                          case_id=case_id,
                          variant_id=variant_id) }}">
        {{ variant.display_name }}
      </a>
    </li>
    <li class="list-group-item">
      <strong>HGNC symbols</strong>:
      {{ variant.hgnc_symbols|join(', ') }}
    </li>

    <li class="list-group-item disabled"><strong>GT call</strong></li>
    {% for individual in variant.samples %}
      <li class="list-group-item">
        {{ individual.display_name }}: {{ individual.genotype_call }}
      </li>
    {% endfor %}

    <li class="list-group-item">
      <strong>Ordered by</strong>:
      {{ current_user.name }}
    </li>
  </ul>
{% endmacro %}

{% macro pin_button() %}
  {% if variant not in case.suspects %}
    <form action="{{ url_for('core.pin_variant',
                             institute_id=institute.internal_id,
                             case_id=case.display_name,
                             variant_id=variant_id) }}"
          method="POST">
      <button type="submit" class="btn btn-default navbar-btn" title="Pin variant">Pin</button>
    </form>
  {% else %}
    <form action="{{ url_for('core.unpin_variant',
                             institute_id=institute.internal_id,
                             case_id=case.display_name,
                             variant_id=variant_id) }}"
          method="POST">
      <button type="submit" class="btn btn-default navbar-btn" title="Unpin variant">Unpin</button>
    </form>
  {% endif %}
{% endmacro %}

{% macro causative_button() %}
  {% if variant in case.causatives %}
      <form action="{{ url_for('core.unmark_causative',
                               institute_id=institute.internal_id,
                               case_id=case.display_name,
                               variant_id=variant.id) }}"
            method="POST">
        <button type="submit" class="btn btn-default navbar-btn" title="Reset causative">
          Reset causative
        </button>
      </form>
  {% else %}
    <form action="{{ url_for('core.mark_causative',
                             institute_id=institute.internal_id,
                             case_id=case.display_name,
                             variant_id=variant_id) }}"
          method="POST">
      <button type="submit" class="btn btn-default navbar-btn" title="Mark causative" onclick="return confirm('Are you sure?')">
        Mark causative
      </button>
    </form>
  {% endif %}
{% endmacro %}

{% macro matching_variants() %}
  <div class="panel panel-default">
    <div class="panel-heading">Matching causatives from other cases</div>
    <ul class="list-group">
      {% for o_variant in causatives %}
        <li class="list-group-item">
          <a href="{{ url_for('core.variant',
                                    institute_id=institute_id,
                                    case_id=o_variant.case_displayname,
                                    variant_id=o_variant.id) }}">
            {{ o_variant.case_id }}
          </a>
        </li>
      {% else %}
        <li class="list-group-item">No matching causative variants.</li>
      {% endfor %}
    </ul>
  </div>
{% endmacro %}

{% macro panel_basics() %}
  <div class="panel panel-default">
    <div class="panel-heading">Basics</div>
    <table class="table table-bordered table-fixed">
      <tbody>
        <tr>
          <td>
            Position
            <span class="pull-right"><strong>{{ variant.chromosome }}:{{ variant.position }}</strong></span>
          </td>
          <td>
            Change
            <span class="pull-right"><strong>{{ variant.reference }} → {{ variant.alternative }}</strong></span>
          </td>
        </tr>
      </tbody>
    </table>
    <div class="table-responsive">
      <table class="table table-bordered">
        <thead class="border-top">
          <tr class="active">
            <th>Gene</th>
            <th>Region</th>
            <th>Function</th>
          </tr>
        </thead>
        <tbody>
          {% for gene in variant.genes %}
            <tr>
              <th>{{ gene_link(gene) }}</th>
              <td>{{ gene.region_annotation }}</td>
              <td>{{ gene.functional_annotation|truncate(20, True) }}</td>
            </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
    <div class="panel-body">
      <form action="{{ url_for('api.manual_rank', institute_id=institute_id, case_id=case_id, variant_id=variant_id) }}" method="POST">
        <label>Priority</label>
        <div class="row">
          <div class="col-xs-8">
            <select name="manual_rank" class="form-control">
              {% for rank in manual_rank_options %}
                <option {% if rank == variant.manual_rank %}selected{% endif %}
                        value="{{ rank }}">
                  {{ rank }}
                </option>
              {% endfor %}
            </select>
          </div>
          <div class="col-xs-4">
            <button type="submit" class="btn btn-default form-control">Save</button>
          </div>
        </div>
      </form>
    </div>
  </div>
{% endmacro %}

{% macro panel_summary() %}
  <div class="panel panel-default">
    <div class="panel-heading">Summary</div>
    <table class="table table-bordered table-fixed">
      <tbody>
        <tr>
          <td>
            Rank
            <span class="pull-right"><strong>{{ variant.variant_rank }}</strong></span>
          </td>
          <td>
            Rank score
            <span class="pull-right"><strong>{{ variant.rank_score }}</strong></span>
          </td>
          <td>
            CADD score
            <span class="pull-right"><strong>{{ variant.cadd_score or '-' }}</strong></span>
          </td>
        </tr>
      </tbody>
    </table>
    <table class="table table-bordered table-fixed">
      <tbody class="border-top">
        <tr>
          <td>
            Matches OMIM inhert.
            {% if variant.is_matching_inheritance %}
              <span class="label label-success pull-right">Yes</span>
            {% else %}
              <div class="label label-warning pull-right">No</div>
            {% endif %}
          </td>
          <td>
            Frequency
            <div class="label label-{% if variant.frequency == 'common' %}danger{% elif variant.frequency == 'uncommon' %}warning{% else %}success{% endif %} pull-right">
              {{ variant.frequency }}
            </div>
          </td>
        </tr>
      </tbody>
    </table>
    <ul class="list-group">
      <li class="list-group-item">
        CLINSIG
        <span class="pull-right">
          {% for clinsig, human_str in variant.clnsig_human %}
            <a href="http://www.ncbi.nlm.nih.gov/clinvar/{{ clinsig.accession }}" target="_blank">
              {{ human_str }}
            </a>
          {% else %}
            <i>No annotations</i>
          {% endfor %}
        </span>
      </li>
      {% if variant.db_snp_ids %}
        <li class="list-group-item">
          SNPedia
          <span class="pull-right">
            {% for rsnumber in variant.db_snp_ids %}
              <a target="_blank" href="http://snpedia.com/index.php/{{ rsnumber }}">
                {{ rsnumber }}
              </a>
            {% endfor %}
          </span>
        </li>
      {% endif %}
    </ul>
    <div class="panel-heading">Gene coverage</div>
    <table class="table table-bordered table-fixed">
      <tbody>
        <tr>
          <td>
            <a class="md-label" href="{{ url_for('pileup.viewer', bam=case.bam_files, bai=case.bai_files, sample=case.sample_names, contig=variant.chromosome, start=(variant.position - 50), stop=(variant.end_position + 50), vcf=case.vcf_file) }}" target="_blank">View alignment</a>
          </td>
          {% for gene_id, link in coverage_links.items() %}
            <td>
              <a target="_blank" href="{{ link }}">{{ gene_id }}</a>
            </td>
          {% endfor %}
        </tr>
      </tbody>
    </table>
  </div>
{% endmacro %}

{% macro transcript_overview() %}
  <div class="panel panel-default">
    <div class="panel-heading">Transcript overview</div>
    <table class="table table-bordered table-hover">
      <thead>
        <tr>
          <th>Gene</th>
          <th>Transcript</th>
          <th>HGVS Description</th>
        </tr>
      </thead>
      <tbody>
        {% for transcript, hgnc_tx in variant.refseq_transcripts %}
          <tr>
            <td>
              <a href="{{ url_for('genes.gene', hgnc_id=hgnc_tx.hgnc_id) }}">
                {{ hgnc_tx.hgnc_symbol }}
              </a>
              {% if transcript.is_canonical %}
                <span class="badge pull-right" title="cannonical">C</span>
              {% endif %}
            </td>
            <td>{{ hgnc_tx.refseq_id }}</td>
            {% if transcript.is_exonic() %}
              <td>{{ (transcript.protein_sequence_name or '')|url_decode }}</td>
            {% else %}
              <td>{{ (transcript.coding_sequence_name or '')|url_decode }}</td>
            {% endif %}
          </tr>
        {% else %}
          <tr>
            <td colspan="3">No RefSeq transcripts</td>
          </tr>
        {% endfor %}
      </tbody>
    </table>
    <div class="panel-heading">Disease associated transcripts</div>
    <div class="panel-body">
      {% for gene in variant.genes %}
        {% for tx_id in gene.panel_info.disease_associated_transcripts %}
          {{ gene.common.hgnc_symbol or gene.hgnc_id }}:{{ tx_id }}
        {% endfor %}
      {% endfor %}
    </div>
  </div>
{% endmacro %}

{% macro frequency_list() %}
  <div class="panel panel-default">
    <div class="panel-heading">Frequency</div>
    <ul class="list-group">
      <li class="list-group-item">
        {% if variant.db_snp_ids %}
          <a href="{{ variant.thousandg_link }}" target="_blank">1000G</a>
        {% else %}
          1000G
        {% endif %}
        <span class="pull-right">
          {% if variant.max_thousand_genomes_frequency %}
            {{ variant.max_thousand_genomes_frequency|human_decimal }} <small>(max)</small> |
          {% endif %}
          {{ variant.thousand_genomes_frequency|human_decimal }}
        </span>
      </li>
      <li class="list-group-item">
        <a title="Exome Aggregation Consortium" target="_blank" href="{{ variant.exac_link }}">ExAC</a>
        <span class="pull-right">
          {% if variant.max_exac_frequency %}
            {{ variant.max_exac_frequency|human_decimal }} <small>(max)</small> |
          {% endif %}
          {{ variant.exac_frequency|human_decimal }}
        </span>
      </li>
    </ul>
    <div class="panel-heading">
      <a href="http://www.clinicalgenomics.se/scout/user-guide/using-scout/" target="_blank">Local</a>
    </div>
    <ul class="list-group">
      <li class="list-group-item">
        <div class="row">
          <div class="col-xs-4">
            {{ local_freq.observations|default('N/A') }} <small>obs.</small>
          </div>
          <div class="col-xs-4">
            {{ local_freq.homozygote|default('N/A') }} <small>homo.</small>
          </div>
          <div class="col-xs-4">
            {{ local_total }} <small>tot.</small>
          </div>
        </div>
      </li>
    </ul>
  </div>
{% endmacro %}

{% macro severity_list() %}
  <div class="panel panel-default">
    <div class="panel-heading">Severity</div>
    <ul class="list-group">
      <li class="list-group-item">
        Sift
        <span class="pull-right">{{ variant.sift_predictions|join(', ') }}</span>
      </li>
      <li class="list-group-item">
        <a href="http://genetics.bwh.harvard.edu/pph2/" target="_blank">Polyphen</a>
        <span class="pull-right">{{ variant.polyphen_predictions|join(', ') }}</span>
      </li>
      <li class="list-group-item">
        SPIDEX
        <span class="pull-right">{{ variant.spidex_human }}</span>
      </li>
    </ul>
    <div class="panel-heading">Conservation</div>
    <ul class="list-group">
      <li class="list-group-item">
        PHAST
        <span class="pull-right">{{ variant.phast_conservation|join(', ') or '-' }}</span>
      </li>
      <li class="list-group-item">
        GERP
        <span class="pull-right">{{ variant.gerp_conservation|join(', ') or '-' }}</span>
      </li>
      <li class="list-group-item">
        phyloP
        <span class="pull-right">{{ variant.phylop_conservation|join(', ') or '-' }}</span>
      </li>
    </ul>
  </div>
{% endmacro %}

{% macro inheritance_panel() %}
  <div class="panel panel-default">
    <div class="panel-heading">Inheritance models</div>
    <ul class="list-group">
      <li class="list-group-item">
        Variant
        <span class="pull-right">
          {% for model in variant.genetic_models|sort %}
            <span class="label label-default">{{ model }}</span>
          {% else %}
            <span class="label label-warning">No models followed</span>
          {% endfor %}
        </span>
      </li>
      {% if variant.expected_inheritance %}
        <li class="list-group-item">
          Expected
          <span class="pull-right">
            {% for model in variant.expected_inheritance|sort %}
              <span class="label label-default">{{ model }}</span>
            {% endfor %}
          </span>
        </li>
      {% endif %}
      {% if variant.omim_inheritance_models %}
        <li class="list-group-item">
          OMIM
          <span class="pull-right">
            {% for model in variant.omim_inheritance_models|sort %}
              <span class="label label-default">{{ model }}</span>
            {% endfor %}
          </span>
        </li>
      {% endif %}
    </ul>
    <div class="panel-heading">Reduced penetrance</div>
    <table class="table table-bordered">
      <thead>
        <th>Gene</th>
        <th>OMIM</th>
        <th>Manual</th>
      </thead>
      <tbody>
        {% for gene, omim, manual in variant.reduced_penetrance_genes %}
          <tr>
            <td>{{ gene }}</td>
            <td>
              {% if omim %}
                <span class="label label-success">yes</span>
              {% else %}
                <span class="label label-default">no</span>
              {% endif %}
            </td>
            <td>
              {% if manual %}
                <span class="label label-success">yes</span>
              {% else %}
                <span class="label label-default">no</span>
              {% endif %}
            </td>
          </tr>
        {% else %}
          <tr>
            <td colspan="3">No annotations found</td>
          </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
{% endmacro %}

{% macro omim_phenotypes() %}
  <div class="panel panel-default">
    <div class="panel-heading">OMIM phenotypes</div>
    <table class="table table-bordered table-condensed">
      <thead>
        <tr>
          <th>Gene</th>
          <th>Phenotype</th>
        </tr>
      </thead>
      <tbody>
        {% for gene, term in variant.disease_terms %}
          <tr>
            <td>
              <a href="{{ url_for('genes.gene', hgnc_id=gene.hgnc_id) }}">
                {{ gene.common.hgnc_symbol }}
              </a>
            </td>
            <td><a href="{{ term.disease_link }}">{{ term.display_name }}</a></td>
          </tr>
        {% else %}
          <tr>
            <td colspan="3">No OMIM phenotypes</td>
          </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
{% endmacro %}

{% macro gtcall_panel() %}
  <div class="panel panel-default">
    <div class="panel-heading">GT call</div>
    <div class="table-responsive">
      <table class="table table-bordered">
        <thead>
          <tr>
            <th rowspan="2">Sample</th>
              <th rowspan="2">Genotype (GT)</th>
              <th colspan="2" title="Unfiltered count of reads that support a given allele.">Allele depth (AD)</th>
              <th rowspan="2" title="Phred-scaled confidence that the true genotype is the one provided in GT (max=99).">Genotype quality (GQ)</th>
            </tr>
            <tr>
              <th>Reference</th>
              <th>Alternative</th>
            </tr>
          </tr>
        </thead>
        <tbody>
          {% for individual in variant.samples %}
            {% set status = individuals[individual.sample_id].phenotype_human %}
            <tr class="{{ 'danger' if status == 'affected' }}">
              <td>{{ individual.display_name }}</td>
              <td class="text-center">{{ individual.genotype_call }}</td>
              {% if individual.allele_depths %}
                  {% for number in individual.allele_depths %}
                    <td class="text-right">{{ number }}</td>
                  {% endfor %}
              {% else %}
                  <td class="text-right"><small>N/A</small></td>
                  <td class="text-right"><small>N/A</small></td>
              {% endif %}
              <td class="text-right">{{ individual.genotype_quality }}</td>
            </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
    <div class="panel-footer">
      {% for name, caller in variant.callers %}
        <span class="label label-default">{{ name }}: {{ caller }}</span>
      {% endfor %}
    </div>
  </div>
{% endmacro %}

{% macro pedigree_panel() %}
  <div class="panel panel-default">
    <div class="panel-heading">Individuals</div>
    <div class="panel-body">
      {% if case.individuals|length == 1 %}
        <!-- Don't expect a pedigree visualization -->
        <p>Single sample case: {{ case.individuals.0.display_name }}</p>
      {% else %}
        {{ case.madeline_info|safe }}
      {% endif %}
    </div>
  </div>
{% endmacro %}

{% macro compounds_panel() %}
  <div class="panel panel-default">
    <div class="panel-heading">Compounds</div>
    {{ compounds_table(institute_id, case_id, variant.compounds) }}
  </div>
{% endmacro %}

{% macro rankscore_panel() %}
  <div class="panel panel-default">
    <div class="panel-heading">Rank score results</div>
    <div class="table-responsive">
      <table class="table table-bordered">
        <thead>
          <tr>
            {% for result in variant.rank_score_results %}
              <th><small>{{ result.category }}</small></th>
            {% endfor %}
          </tr>
        </thead>
        <tbody>
          <tr>
            {% for result in variant.rank_score_results %}
              <td class="text-right">
                {{ result.score }}
              </td>
            {% endfor %}
          <tr>
        </tbody>
      </table>
    </div>
  </div>
{% endmacro %}

{% macro overlapping_svs() %}
  <div class="panel panel-default">
    <div class="panel-heading">Overlapping SVs</div>
    <table class="table table-bordered">
      <thead>
        <tr>
          <th>Variant</th>
          <th>Combined score</th>
          <th>Rank score</th>
          <th>Length</th>
          <th>Region</th>
          <th>Function</th>
        </tr>
      </thead>
      <tbody>
        {% for sv_variant in sv_compounds %}
          <tr>
            <td>
              <a href="{{url_for('sv.variant',
                                 institute_id=institute_id,
                                 case_id=case_id,
                                 variant_id=sv_variant.document_id)}}">
                {{ sv_variant.db_snp_ids|join(', ') }}
              </a>
            </td>
            <td class="text-right">{{ variant.rank_score + sv_variant.rank_score }}</td>
            <td class="text-right">{{ sv_variant.rank_score }}</td>
            <td class="text-right">{{ sv_variant.length }}</td>
            <td>{{ sv_variant.region_annotations|join(',') }}</td>
            <td>{{ sv_variant.functional_annotations|join(',') }}</td>
          </tr>
        {% else %}
          <tr>
            <td colspan="6">No overlapping SVs found</td>
          </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
{% endmacro %}

{% macro genes_panel() %}
  <div class="panel panel-default">
    <table class="table table-bordered">
      <thead>
        <tr>
          <th>Gene</th>
          <th>Ensembl ID</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
        {% for gene in variant.genes %}
          <tr>
            <td>{{ gene_link(gene) }}</td>
            <td>
              <a target="_blank" href="{{ gene.common.ensembl_link }}">
                {{ gene.common.ensembl_id }}
              </a>
            </td>
            <td>{{ gene.common.description }}</td>
          </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
{% endmacro %}

{% macro transcripts_panel() %}
  <div class="panel panel-default">
    <table class="table table-bordered">
      <thead>
        <tr>
          <th>Gene</th>
          <th>Transcript</th>
          <th>RefSeq</th>
          <th>Biotype</th>
          <th>Mutation type</th>
          <th>Strand</th>
          <th>Exon</th>
          <th>Intron</th>
          <th>cDNA</th>
          <th>Amino acid</th>
        </tr>
      </thead>

      <tbody>
        {% for gene, transcript in variant.transcripts %}
          <tr class="{{ 'danger' if transcript.is_disease_associated }}">
            <td>
              {{ gene.common.hgnc_symbol }}
              {% if transcript.is_canonical %}
                <span class="badge pull-right">*</span>
              {% endif %}
            </td>
            <td>
              <a target="_blank" href="{{ transcript.ensembl_link }}">
                {{ transcript.transcript_id }}
              </a>
            </td>
            <td>
              {% if transcript.common %}
                <a href="{{ transcript.common.refseq_link }}">
                  {{ transcript.common.refseq_id }}
                </a>
              {% endif %}
            </td>
            <td>{{ transcript.biotype or '' }}</td>
            <td data-toggle="tooltip" data-placement="right" title="{{ transcript.functional_annotations|join(', ') }}">
              {{ transcript.functional_annotations
                    |join(', ')
                    |truncate(20, True) }}
            </td>
            <td class="text-center">{{ transcript.strand }}</td>
            <td>{{ transcript.exon or '' }}</td>
            <td>{{ transcript.intron or '' }}</td>
            <td>{{ (transcript.coding_sequence_name or '')|url_decode }}</td>
            <td>{{ (transcript.protein_sequence_name or '')|url_decode }}</td>
          </tr>
        {% else %}
          <tr>
            <td colspan="10">
              No protein change predictions available
            </td>
          </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
{% endmacro %}

{% macro proteins_panel() %}
  <div class="panel panel-default">
    <table class="table table-bordered">
      <thead>
        <tr>
          <th>Gene</th>
          <th>Transcript</th>
          <th>Protein</th>
          <th>SWISS PROT</th>
          <th>Sift</th>
          <th>Polyphen</th>
          <th>Pfam</th>
          <th>ProSite</th>
          <th>Smart</th>
        </tr>
      </thead>
      <tbody>
        {% for gene, transcript in variant.transcripts %}
          <tr>
            <td>{{ gene.common.hgnc_symbol }}</td>
            <td>
              <a target="_blank" href="{{ transcript.ensembl_link }}">
                {{ transcript.transcript_id }}
              </a>
            </td>
            <td>{{ transcript.protein_id or '' }}</td>
            <td>
              {% if transcript.swiss_prot != 'unknown' %}
                <a target="_blank" href="{{ transcript.swiss_prot_link }}">
                  {{ transcript.swiss_prot or '' }}
                </a>
              {% else %}
                {{ transcript.swiss_prot }}
              {% endif %}
            </td>
            <td>{{ transcript.sift_prediction }}</td>
            <td>{{ transcript.polyphen_prediction }}</td>
            <td>
              <a target="_blank" href="{{ transcript.pfam_domain_link }}">
                {{ transcript.pfam_domain or '' }}
              </a>
            </td>
            <td>
              <a target="_blank" href="{{ transcript.prosite_profile_link }}">
                {{ transcript.prosite_profile or '' }}
              </a>
            </td>
            <td>
              <a target="_blank" href="{{ transcript.smart_domain_link }}">
                {{ transcript.smart_domain or '' }}
              </a>
            </td>
          </tr>
        {% else %}
          <tr>
            <td colspan="10">
              No protein change predictions available
            </td>
          </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
{% endmacro %}

{% macro modal_sanger() %}
  <form action="{{ url_for('core.email_sanger',
                           institute_id=institute_id,
                           case_id=case_id,
                           variant_id=variant_id) }}"
        method="POST">
    <div class="modal fade" id="sangerModal">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <button class="close" data-dismiss="modal">&times;</button>
            <h4 class="modal-title">Order Sanger sequencing</h4>
          </div>
          <div class="modal-body">
            {{ sanger_form() }}
          </div>
          <div class="modal-footer">
            <button class="btn btn-default" data-dismiss="modal">Close</button>
            <button type="submit" class="btn btn-primary">Send</button>
          </div>
        </div>
      </div>
    </div>
  </form>
{% endmacro %}

{% macro external_links() %}
  <div class="panel panel-default">
    {% for gene in variant.genes %}
      <div class="panel-heading">
        External links: {{ gene.common.hgnc_symbol or "HGNC:%s"|format(gene.hgnc_id) }}
      </div>
      <div class="panel-body">
        <div class="btn-group btn-group-justified">
          <a href="{{ gene.common.ensembl_link }}" class="btn btn-default">Ensembl</a>
          <a href="{{ gene.common.hpa_link }}" class="btn btn-default">HPA</a>
          <a href="{{ gene.common.string_link }}" class="btn btn-default">STRING</a>
          <a href="{{ variant.ucsc_link }}" class="btn btn-default">UCSC</a>
          <a href="{{ gene.common.entrez_link }}" class="btn btn-default">Entrez</a>
          <a href="http://tools.genes.toronto.edu/" class="btn btn-default">SPANR</a>
          <a href="{{ gene.common.reactome_link }}" class="btn btn-default">Reactome</a>
          <a href="{{ gene.common.expression_atlas_link }}" class="btn btn-default">Expr. Atlas</a>
        </div>
      </div>
    {% endfor %}
  </div>
{% endmacro %}

{% macro gene_link(gene) %}
  {% if gene.common %}
    <a href="{{ url_for('genes.gene', hgnc_id=gene.common.hgnc_id) }}">
      {{ gene.common.hgnc_symbol }}
    </a>
  {% else %}
    <a href="{{ gene.genecards_link }}">HGNC:{{ gene.hgnc_id }}</a>
  {% endif %}
{% endmacro %}

{% block scripts %}
  {{ super() }}

  <script>
    $(function () {
      $('[data-toggle="tooltip"]').tooltip({
        container: 'body'
      });
    })
  </script>
{% endblock %}
