{% extends "core/layout.html" %}
{% from "core/case/action-bar.html" import action_bar, research_modal, rerun_modal %}
{% from "core/utils.html" import comments_panel, activity_panel %}

{% block title %}
  {{ super() }} - {{ institute.display_name }} - {{ case.display_name }}
{% endblock %}

{% block top_nav %}
  <li>
    <a href="{{ url_for('core.cases', institute_id=institute_id) }}">
      {{ institute.display_name }}
    </a>
  </li>
  <li class="active">
    <a href="{{ url_for('core.case', institute_id=institute_id, case_id=case_id) }}">
      {{ case.display_name }}
    </a>
  </li>
{% endblock %}

{% block content %}
  <div class="container-fluid">
    <div class="row">
      <div class="col-sm-3 col-md-2 sidebar">
        {{ action_bar(institute, case, collaborators) }}
      </div>

      <div class="col-sm-9 col-sm-offset-3 col-md-10 col-md-offset-2 main">
        {% if archive.status in ('before', 'close') %}
          <div class="row">
            <div class="col-xs-12">{{ postpone_btn() }}</div>
          </div>
        {% endif %}

        {{ variant_buttons() }}
        {{ matching_list() }}

        <div class="row">
          <div class="col-md-4">{{ individuals_table() }}</div>
          <div class="col-md-4">{{ pedigree_panel() }}</div>
          <div class="col-md-4">{{ synopsis_panel() }}</div>
        </div>

        <div class="row">
          <div class="col-md-4">{{ candidates_list() }}</div>
          <div class="col-md-4">{{ diagnosis_panel() }}</div>
          <div class="col-md-4">{{ comments_panel(institute, case, current_user, case_comments|reverse) }}</div>
        </div>

        <div class="row">
          <div class="col-md-6">{{ phenotype_groups_panel() }}</div>
          <div class="col-md-6">{{ phenotypes_panel() }}</div>
        </div>

        <div class="row">
          <div class="col-md-8">{{ genepanels_table() }}</div>
          <div class="col-md-4">{{ hpo_genelist_panel() }}</div>
        </div>

        <div class="row">
          <div class="col-md-12">{{ activity_panel(case_events|reverse) }}</div>
        </div>
      </div>
    </div>
  </div>

  {{ modal_synopsis() }}
  {{ research_modal(institute, case) }}
  {{ rerun_modal(institute, case) }}
{% endblock %}

{% macro postpone_btn() %}
  <form action="{{ url_for('core.postpone', institute_id=institute_id, case_id=case_id) }}" method="POST">
    <button class="btn btn-{{ 'warning' if archive.status == 'close' else 'default' }} form-control" type="submit" onclick="return confirm('Are you sure?')">
      Will archive on: {{ archive.date }} -- postpone 30 days?
    </button>
  </form>
{% endmacro %}

{% macro variant_buttons() %}
  <div class="form-group">
    <div class="btn-group btn-group-justified">
      <a class="btn btn-default" href="{{ url_for('core.variants', institute_id=institute.id, case_id=case.display_name, variant_type='clinical', gene_lists=case.default_panel_ids) }}">Clinical variants</a>

      <a class="btn btn-default" href="{{ url_for('sv.variants', institute_id=institute.internal_id, case_id=case.display_name, variant_type='clinical') }}">Clinical SV variants</a>

      {% if case.is_research %}
        <a class="btn btn-default" href="{{ url_for('core.variants', institute_id=institute.internal_id, case_id=case.display_name, variant_type='research') }}">Research variants</a>

        <a class="btn btn-default" href="{{ url_for('sv.variants', institute_id=institute.internal_id, case_id=case.display_name, variant_type='research') }}">Research SV variants</a>
      {% endif %}
    </div>
  </div>
{% endmacro %}

{% macro matching_list() %}
  <div class="panel panel-default">
    <div class="panel-heading">Matching causatives from other cases</div>
    <ul class="list-group">
      {% for variant in causatives %}
        <li class="list-group-item">
          <a href="{{ url_for('core.variant',
                                    institute_id=institute.id,
                                    case_id=case.display_name,
                                    variant_id=variant.id) }}">
            {{ variant.hgnc_symbols|join(', ') }}
          </a>
        </li>
      {% else %}
        <li class="list-group-item">No matching causative variants.</li>
      {% endfor %}
    </ul>
  </div>
{% endmacro %}

{% macro individuals_table() %}
  <div class="panel panel-default">
    <div class="panel-heading">Individuals</div>
    <table class="table">
      <thead>
        <tr>
          <th>Sample</th>
          <th>Sex</th>
          <th>Phenotype</th>
          <th>Sequencing</th>
        </tr>
      </thead>
      <tbody>
        {% for ind in case.individuals %}
          <tr {% if ind.phenotype_human == 'affected' %}class="bg-danger"{% endif %}>
            <td>{{ ind.display_name }}</td>
            <td>{{ ind.sex_human }}</td>
            <td>{{ ind.phenotype_human }}</td>
            <td>{{ ind.analysis_type|upper }}</td>
          </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
{% endmacro %}

{% macro pedigree_panel() %}
  <div class="panel panel-default">
    <div class="panel-heading">Pedigree</div>
    <div class="panel-body">
      {% if case.individuals|length == 1 %}
        <!-- Don't expect a pedigree visualization -->
        <p>Single sample case: {{ case.individuals.0.display_name }}</p>
      {% else %}
        {{ case.madeline_info|safe }}
      {% endif %}
    </div>
  </div>
{% endmacro %}

{% macro synopsis_panel() %}
  <div class="panel panel-default">
    <div class="panel-heading">Synopsis</div>
    <div class="panel-body">
      {{ case.synopsis|markdown if case.synopsis else 'Nothing written yet...' }}
    </div>
    <div class="panel-footer">
      <button class="btn btn-default form-control" data-toggle="modal" data-target="#edit-synopsis">Edit</button>
    </div>
  </div>
{% endmacro %}

{% macro modal_synopsis() %}
  <form action="{{ url_for('api.case_synopsis', institute_id=institute.internal_id, case_id=case.display_name) }}" method="POST">
    <div class="modal fade" id="edit-synopsis">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <button class="close" data-dismiss="modal">&times;</button>
            <h4 class="modal-title">Edit synopsis</h4>
          </div>
          <div class="modal-body">
            <textarea name="synopsis" class="form-control" cols="30" rows="10">{{ case.synopsis }}</textarea>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
            <button type="submit" class="btn btn-primary">Save</button>
          </div>
        </div>
      </div>
    </div>
  </form>
{% endmacro %}

{% macro candidates_list() %}
  <div class="panel panel-default">
    <div class="panel-heading">Marked as causative</div>
    <ul class="list-group">
      {% for variant in case.causatives %}
        <li class="list-group-item">
          <div class="row">
            <div class="col-xs-8">
              <span class="glyphicon glyphicon-ok-circle"></span>
              <a href="{{ url_for('core.variant',
                                  institute_id=institute.id,
                                  case_id=case.display_name,
                                  variant_id=variant.id) }}">
                {{ variant.hgnc_symbols|join(', ') }}
              </a>
              {% if variant.sanger_ordered %}
                <span class="label label-success">Sanger ordered</span>
              {% endif %}
            </div>
            <div class="col-xs-4">
              {{ remove_form(url_for('core.unmark_causative',
                                     institute_id=institute.internal_id,
                                     case_id=case.display_name,
                                     variant_id=variant.id)) }}
            </div>
          </div>
        </li>
      {% else %}
        <div class="panel-body">No variants marked causative</div>
      {% endfor %}
    </ul>
    <div class="panel-heading panel-heading-secondary">Stong candidates</div>
    <table class="table table-hover">
      <colgroup>
        <col class="col-xs-5">
        <col class="col-xs-2">
        <col class="col-xs-4">
        <col class="col-xs-1">
      </colgroup>
      <tbody>
        {% for variant in case.suspects %}
          <tr>
            <td>
              <span class="glyphicon glyphicon-bookmark"></span>
              <a href="{{ url_for('core.variant',
                                  institute_id=variant.institute.id,
                                  case_id=case.display_name,
                                  variant_id=variant.id) }}">
                {{ variant.hgnc_symbols|join(', ') }}
              </a>
            </td>
            <td>
              {% if variant.sanger_ordered %}
                <span class="label label-default">Sanger ordered</span>
              {% elif variant.manual_rank %}
                <span class="label label-default">{{ variant.manual_rank }}</span>
              {% endif %}
            </td>
            <td>
              <form action="{{ url_for('core.mark_validation',
                                         institute_id=variant.institute.id,
                                         case_id=case.display_name,
                                         variant_id=variant.id) }}"
                    method="POST" accept-charset="utf-8">
                <select class="form-control input-sm" onchange="this.form.submit()" name="type">
                  <option>Validate Sanger...</option>
                  {% for type in ('True positive', 'False positive') %}
                    <option value="{{ type }}" {% if type == variant.validation %}selected{% endif %}>{{ type }}</option>
                  {% endfor %}
                </select>
              </form>
            </td>
            <td>
              {{ remove_form(url_for('core.unpin_variant',
                                     institute_id=institute.internal_id,
                                     case_id=case.display_name,
                                     variant_id=variant.id)) }}
            </td>
          </tr>
        {% else %}
          <div class="panel-body">No variants suspected yet</div>
        {% endfor %}
      </tbody>
    </table>
  </div>
{% endmacro %}

{% macro remove_form(url, hidden_input=None, button_name=none) %}
  <form action="{{ url }}" method="POST">
    {% if hidden_input %}
      <input type="hidden"
             name="{{ hidden_input[0] }}"
             value="{{ hidden_input[1] }}">
    {% endif %}
    <div class="pull-right">
      <button class="btn btn-link btn-sm"
              name="{{ button_name if button_name }}"
              type="submit">
        <span class="glyphicon glyphicon-remove"></span>
      </button>
    </div>
  </form>
{% endmacro %}

{% macro diagnosis_panel() %}
  <div class="panel panel-default">
    <div class="panel-heading">Diagnosis phenotypes</div>
    <div class="panel-body">{{ diagnosis_form('phenotype') }}</div>
    <ul class="list-group">
      {% for omim_id in case.diagnosis_phenotypes %}
        <li class="list-group-item">
          <a target="_blank" href="http://omim.org/entry/{{ omim_id }}">
            {{ omim_id }}
          </a>
          {{ remove_form(url_for('core.case_diagnosis',
                                 institute_id=institute.internal_id,
                                 case_id=case.display_name,
                                 remove='yes'),
                         hidden_input=('omim_id', omim_id),
                         button_name='phenotype') }}
        </li>
      {% else %}
        <li class="list-group-item">No phenotypes added</li>
      {% endfor %}
    </ul>
    <div class="panel-heading panel-heading-secondary">Diagnosis genes</div>
    <div class="panel-body">{{ diagnosis_form('gene') }}</div>
    <ul class="list-group">
      {% for omim_id in case.diagnosis_genes %}
        <li class="list-group-item">
          <a target="_blank" href="http://omim.org/entry/{{ omim_id }}">
            {{ omim_id }}
          </a>
          {{ remove_form(url_for('core.case_diagnosis',
                                 institute_id=institute.internal_id,
                                 case_id=case.display_name,
                                 remove='yes'),
                         hidden_input=('omim_id', omim_id),
                         button_name='gene') }}
        </li>
      {% else %}
        <li class="list-group-item">No genes added</li>
      {% endfor %}
    </ul>
  </div>
{% endmacro %}

{% macro diagnosis_form(type) %}
  <form action="{{ url_for('core.case_diagnosis', institute_id=institute.id, case_id=case.display_name) }}" method="POST">
    <div class="row">
      <div class="col-xs-8">
        <input class="form-control" name="omim_id" placeholder="OMIM:XXX" pattern="OMIM:[0-9]+">
      </div>
      <div class="col-xs-4">
        <button class="btn btn-default form-control" type="submit" name="{{ type }}">
          Add
        </button>
      </div>
    </div>
  </form>
{% endmacro %}

{% macro phenotype_groups_panel() %}
  <div class="panel panel-default">
    <div class="panel-heading">Phenotype groups</div>
    <ul class="list-group">
      {% for hpo_term in case.phenotype_groups %}
        {{ hpo_group_item(hpo_term) }}
      {% else %}
        <li class="list-group-item">No HPO groups added yet.</li>
      {% endfor %}
    </ul>
    <div class="panel-body">
      <form method="POST"
            action="{{ url_for('core.case_phenotype',
                               institute_id=institute.internal_id,
                               case_id=case.display_name,
                               is_group='yes') }}">
        <div class="row">
          <div class="col-xs-7">
            <select class="form-control" name="hpo_term">
              <option>Add HPO group...</option>
              {% for hpo_id, group in hpo_groups.items() %}
                <option value="{{ hpo_id }}">
                  {{ group.name }} ({{ group.abbr }})
                </option>
              {% endfor %}
            </select>
          </div>
          <div class="col-xs-5">
            <button class="btn btn-default form-control" type="submit">Add</button>
          </div>
        </div>
      </form>
    </div>
    {% set url = 'http://compbio.charite.de/hpoweb/showterm?id=HP:0000018' %}
    <div class="panel-heading panel-heading-secondary">
      Phenotype terms (<a target="_blank" href="{{ url }}">HPO web</a>)
    </div>
    <div class="panel-body">
      <form method="POST"
            action="{{ url_for('core.case_phenotype',
                               institute_id=institute.internal_id,
                               case_id=case.display_name) }}">
        <div class="row">
          <div class="col-xs-7">
            <input name="hpo_term" class="typeahead form-control" data-provide="typeahead" autocomplete="off" placeholder="Search...">
          </div>
          <div class="col-xs-5">
            <button class="btn btn-default form-control">Add</button>
          </div>
        </div>
      </form>
    </div>
  </div>
{% endmacro %}

{% macro hpo_group_item(hpo_term) %}
  <li class="list-group-item">
    <div class="flex">
      <div class="flex-fill">
        {{ hpo_term.feature }}
        <span class="label label-info">
          <a href="{{ hpo_term.hpo_link }}" target="_blank">
            {{ hpo_term.phenotype_id }}
          </a>
        </span>
      </div>
      {{ remove_form(url_for('core.case_phenotype',
                             institute_id=institute.internal_id,
                             case_id=case.display_name,
                             phenotype_id=hpo_term.phenotype_id,
                             is_group='yes')) }}
    </div>
  </li>
{% endmacro %}

{% macro phenotypes_panel() %}
  <form action="{{ url_for('core.phenotypes_gendel', institute_id=institute.id, case_id=case.display_name) }}" method="POST">
    <div class="panel panel-default">
      <div class="panel-heading">Added phenotypes</div>
      <ul class="list-group">
        {% for hpo_term in case.phenotype_terms %}
          {{ hpo_item(hpo_term) }}
        {% else %}
          <li class="list-group-item">No phenotypes added yet</li>
        {% endfor %}
      </ul>
      <div class="panel-footer">
        <div class="row">
          <div class="col-xs-6">
            <button class="btn btn-danger form-control" type="submit" name="action" value="DELETE">Delete</button>
          </div>
          <div class="col-xs-6">
            <button class="btn btn-default form-control" type="submit" name="action" value="GENERATE">Generate panel</button>
          </div>
        </div>
      </div>
    </div>
  </form>
{% endmacro %}

{% macro hpo_item(hpo_term) %}
  <li class="list-group-item">
    <input type="checkbox" name="hpo_id" value="{{ hpo_term.phenotype_id }}"
           {% if selected_ids and hpo_term.phenotype_id in selected_ids %}checked{% endif %}>
    {{ hpo_term.feature }}
    <span class="label label-info">
      <a href="{{ hpo_term.hpo_link }}" target="_blank">
        {{ hpo_term.phenotype_id }}
      </a>
    </span>
  </li>
{% endmacro %}

{% macro hpo_genelist_panel() %}
  <div class="panel panel-default">
    <div class="panel-heading">
      HPO gene list ({{ case.dynamic_gene_list|length }} genes)
    </div>
    <ul class="list-group">
      {% for hpo_gene in case.dynamic_gene_list %}
        <li class="list-group-item" title="{{ hpo_gene.description }}">
          {{ hpo_gene.gene_id }}
        </li>
      {% else %}
        <li class="list-group-item">No gene list generated</li>
      {% endfor %}
    </ul>
  </div>
{% endmacro %}

{% macro genepanels_table() %}
  <div class="panel panel-default">
    <div class="panel-heading">Gene panels</div>
    <table class="table">
      <thead>
        <tr>
          <th>Panel</th>
          <th>Version</th>
          <th>Last update</th>
          <th>Coverage</th>
        </tr>
      </thead>
      <tbody>
        {% for panel in case.gene_panels %}
          <tr>
            <td>
              <a href="{{ url_for('core.gene_panel', institute_id=institute.id, case_id=case.display_name, panel_id=panel.panel_name) }}">
                {{ panel.display_name }}
              </a>
            </td>
            <td>{{ panel.version }}</td>
            <td>{{ panel.date.date() if panel.date }}</td>
            <td>
              <form action="{{ url_for('report.report', group_id=case.case_id, panel_name=panel.name_and_version, level=institute.coverage_cutoff) }}" method="POST" target="_blank">
                <input type="hidden" name="gene_ids" value="{{ panel.gene_ids|join(',') }}">
                <button type="submit" class="btn btn-link btn-sm form-control">View</button>
              </form>
            </td>
          </tr>
        {% else %}
          <tr>
            <td colspan="5">No panels linked to case</td>
          </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
{% endmacro %}

{% block scripts %}
  {{ super() }}
  <script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-3-typeahead/4.0.2/bootstrap3-typeahead.min.js"></script>
  <script>
    $(function () {
      function getTerms(query, process) {
        $.get("{{ url_for('core.hpoterms') }}", {query: query}, function(data) {
          process(data)
        });
      }

      $(".typeahead").typeahead({
        source: getTerms,
        minLength: 3,
      });
    })
  </script>
{% endblock %}
