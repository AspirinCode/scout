{% extends "core/layout.html" %}
{% from "core/case/action-bar.html" import action_bar, research_modal, rerun_modal %}
{% from "core/utils.html" import comments_panel, activity_panel %}

{% block content %}
  <div class="container-fluid">
    <div class="row">
      {% if case.status == 'solved' %}
        {% set bg_class = 'bg-success' %}
      {% elif case.status == 'archived' %}
        {% set bg_class = 'bg-warning' %}
      {% endif %}
      <div class="col-sm-3 col-md-2 sidebar {{ bg_class if bg_class }}">
        {{ action_bar(institute, case, collaborators) }}
      </div>

      <div class="col-sm-9 col-sm-offset-3 col-md-10 col-md-offset-2 main">
        {{ variant_buttons() }}
        {{ matching_list() }}

        <div class="row">
          <div class="col-md-4">{{ individuals_table() }}</div>
          <div class="col-md-4">{{ pedigree_panel() }}</div>
          <div class="col-md-4">{{ synopsis_panel() }}</div>
        </div>

        <div class="row">
          <div class="col-md-4">{{ candidates_list() }}</div>
          <div class="col-md-4">{{ diagnosis_panel() }}</div>
          <div class="col-md-4">{{ comments_panel(institute, case, current_user, case_comments|reverse) }}</div>
        </div>

        <div class="row">
          <div class="col-md-6">{{ phenotype_groups_panel() }}</div>
          <div class="col-md-6">{{ phenotypes_panel() }}</div>
        </div>

        <div class="row">
          <div class="col-md-6">{{ genepanels_table() }}</div>
          <div class="col-md-6">{{ hpo_genelist_panel() }}</div>
        </div>

        <div class="row">
          <div class="col-md-12">{{ activity_panel(case_events|reverse) }}</div>
        </div>
      </div>
    </div>
  </div>

  {{ modal_synopsis() }}
  {{ research_modal(institute, case) }}
  {{ rerun_modal(institute, case) }}
{% endblock %}

{% macro postpone_btn() %}
  <form action="{{ url_for('core.postpone', institute_id=institute_id, case_id=case_id) }}" method="POST">
    <button class="btn btn-{{ 'warning' if archive.status == 'close' else 'default' }} form-control" type="submit" onclick="return confirm('Are you sure?')">
      Will archive on: {{ archive.date }} -- postpone 30 days?
    </button>
  </form>
{% endmacro %}

{% macro remove_form(url, hidden_input=None, button_name=none) %}
  <form action="{{ url }}" method="POST">
    {% if hidden_input %}
      <input type="hidden"
             name="{{ hidden_input[0] }}"
             value="{{ hidden_input[1] }}">
    {% endif %}
    <div class="pull-right">
      <button class="btn btn-link btn-sm"
              name="{{ button_name if button_name }}"
              type="submit">
        <span class="glyphicon glyphicon-remove"></span>
      </button>
    </div>
  </form>
{% endmacro %}

{% macro diagnosis_panel() %}
  <div class="panel panel-default">
    <div class="panel-heading">Diagnosis phenotypes</div>
    <div class="panel-body">{{ diagnosis_form('phenotype') }}</div>
    <ul class="list-group">
      {% for omim_id in case.diagnosis_phenotypes %}
        <li class="list-group-item">
          <a target="_blank" href="http://omim.org/entry/{{ omim_id }}">
            {{ omim_id }}
          </a>
          {{ remove_form(url_for('core.case_diagnosis',
                                 institute_id=institute.internal_id,
                                 case_id=case.display_name,
                                 remove='yes'),
                         hidden_input=('omim_id', omim_id),
                         button_name='phenotype') }}
        </li>
      {% else %}
        <li class="list-group-item">No phenotypes added</li>
      {% endfor %}
    </ul>
    <div class="panel-heading panel-heading-secondary">Diagnosis genes</div>
    <div class="panel-body">{{ diagnosis_form('gene') }}</div>
    <ul class="list-group">
      {% for omim_id in case.diagnosis_genes %}
        <li class="list-group-item">
          <a target="_blank" href="http://omim.org/entry/{{ omim_id }}">
            {{ omim_id }}
          </a>
          {{ remove_form(url_for('core.case_diagnosis',
                                 institute_id=institute.internal_id,
                                 case_id=case.display_name,
                                 remove='yes'),
                         hidden_input=('omim_id', omim_id),
                         button_name='gene') }}
        </li>
      {% else %}
        <li class="list-group-item">No genes added</li>
      {% endfor %}
    </ul>
  </div>
{% endmacro %}

{% macro phenotype_groups_panel() %}
  <div class="panel panel-default">
    <div class="panel-heading">Phenotype groups</div>
    <ul class="list-group">
      {% for hpo_term in case.phenotype_groups %}
        {{ hpo_group_item(hpo_term) }}
      {% else %}
        <li class="list-group-item">No HPO groups added yet.</li>
      {% endfor %}
    </ul>
    <div class="panel-body">
      <form method="POST"
            action="{{ url_for('core.case_phenotype',
                               institute_id=institute.internal_id,
                               case_id=case.display_name,
                               is_group='yes') }}">
        <div class="row">
          <div class="col-xs-7">
            <select class="form-control" name="hpo_term">
              <option>Add HPO group...</option>
              {% for hpo_id, group in hpo_groups.items() %}
                <option value="{{ hpo_id }}">
                  {{ group.name }} ({{ group.abbr }})
                </option>
              {% endfor %}
            </select>
          </div>
          <div class="col-xs-5">
            <button class="btn btn-default form-control" type="submit">Add</button>
          </div>
        </div>
      </form>
    </div>
    {% set url = 'http://compbio.charite.de/hpoweb/showterm?id=HP:0000018' %}
    <div class="panel-heading panel-heading-secondary">
      Phenotype terms (<a target="_blank" href="{{ url }}">HPO web</a>)
    </div>
    <div class="panel-body">
      <form method="POST"
            action="{{ url_for('core.case_phenotype',
                               institute_id=institute.internal_id,
                               case_id=case.display_name) }}">
        <div class="row">
          <div class="col-xs-7">
            <input name="hpo_term" class="typeahead form-control" data-provide="typeahead" autocomplete="off" placeholder="Search...">
          </div>
          <div class="col-xs-5">
            <button class="btn btn-default form-control">Add</button>
          </div>
        </div>
      </form>
    </div>
  </div>
{% endmacro %}

{% macro hpo_group_item(hpo_term) %}
  <li class="list-group-item">
    <div class="flex">
      <div class="flex-fill">
        {{ hpo_term.feature }}
        <span class="label label-info">
          <a href="{{ hpo_term.hpo_link }}" target="_blank">
            {{ hpo_term.phenotype_id }}
          </a>
        </span>
      </div>
      {{ remove_form(url_for('core.case_phenotype',
                             institute_id=institute.internal_id,
                             case_id=case.display_name,
                             phenotype_id=hpo_term.phenotype_id,
                             is_group='yes')) }}
    </div>
  </li>
{% endmacro %}

{% macro phenotypes_panel() %}
  <form action="{{ url_for('core.phenotypes_gendel', institute_id=institute.id, case_id=case.display_name) }}" method="POST">
    <div class="panel panel-default">
      <div class="panel-heading">Added phenotypes</div>
      <ul class="list-group">
        {% for hpo_term in case.phenotype_terms %}
          {{ hpo_item(hpo_term) }}
        {% else %}
          <li class="list-group-item">No phenotypes added yet</li>
        {% endfor %}
      </ul>
      <div class="panel-footer">
        <div class="row">
          <div class="col-xs-3">
            <button class="btn btn-danger form-control" type="submit" name="action" value="DELETE">Delete</button>
          </div>
          <div class="col-xs-4">
            <button class="btn btn-default form-control" type="submit" name="action" value="PHENOMIZER">Phenomizer</button>
          </div>
          <div class="col-xs-5">
            <div class="input-group">
              <span class="input-group-btn">
                <button class="btn btn-default" type="submit" name="action" value="GENERATE">HPO panel</button>
              </span>
              <input name="min_match" type="number" min="0" step="1" class="form-control" placeholder="Min matches">
            </div>
          </div>
        </div>
      </div>
    </div>
  </form>
{% endmacro %}

{% macro hpo_item(hpo_term) %}
  <li class="list-group-item">
    <input type="checkbox" name="hpo_id" value="{{ hpo_term.phenotype_id }}"
           {% if selected_ids and hpo_term.phenotype_id in selected_ids %}checked{% endif %}>
    {{ hpo_term.feature }}
    <span class="label label-info">
      <a href="{{ hpo_term.hpo_link }}" target="_blank">
        {{ hpo_term.phenotype_id }}
      </a>
    </span>
  </li>
{% endmacro %}

{% macro hpo_genelist_panel() %}
  <div class="panel panel-default">
    <div class="panel-heading">
      HPO gene panel ({{ case.dynamic_gene_list|length }} genes)
    </div>
    <ul class="list-group fixed-panel">
      {% for hpo_gene in case.dynamic_gene_list %}
        <li class="list-group-item" title="{{ hpo_gene.description }}">
          {{ hpo_gene.hgnc_symbol }}
        </li>
      {% else %}
        <li class="list-group-item">No gene list generated</li>
      {% endfor %}
    </ul>
  </div>
{% endmacro %}

{% macro genepanels_table() %}
  <div class="panel panel-default">
    <div class="panel-heading">Gene panels</div>
    <div class="table-responsive fixed-panel">
      <table class="table">
        <thead>
          <tr>
            <th>Panel</th>
            <th>Version</th>
            <th>Last update</th>
          </tr>
        </thead>
        <tbody>
          {% for panel in case.gene_panels %}
            <tr>
              <td>
                <a href="{{ url_for('core.gene_panel', institute_id=institute.id, case_id=case.display_name, panel_id=panel.panel_name) }}">
                  {{ panel.display_name }}
                </a>
              </td>
              <td>{{ panel.version }}</td>
              <td>{{ panel.date.date() if panel.date }}</td>
            </tr>
          {% else %}
            <tr>
              <td colspan="5">No panels linked to case</td>
            </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>
{% endmacro %}

{% block scripts %}
  {{ super() }}
  <script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-3-typeahead/4.0.2/bootstrap3-typeahead.min.js"></script>
  <script>
    $(function () {
      function getTerms(query, process) {
        $.get("{{ url_for('core.hpoterms') }}", {query: query}, function(data) {
          process(data)
        });
      }

      $(".typeahead").typeahead({
        source: getTerms,
        minLength: 3,
      });
    })
  </script>
{% endblock %}
