{% extends "sv/layout.html" %}

{% block title %}
  {{ super() }} - {{ case.display_name }} - SV variants
{% endblock %}

{% block top_nav %}
  <li>
    <a href="{{ url_for('core.cases', institute_id=institute_id) }}">
      {{ institute.display_name }}
    </a>
  </li>
  <li>
    <a href="{{ url_for('core.case', institute_id=institute_id, case_id=case_id) }}">
      {{ case.display_name }}
    </a>
  </li>
  <li class="active">
    <a href="{{ url_for('sv.variants', institute_id=institute_id, case_id=case_id, variant_type=query.variant_type, gene_lists=case.default_panels) }}">
      {{ query.variant_type|capitalize }} SV variants
    </a>
  </li>
{% endblock %}

{% block content %}
  <div class="table-responsive">
    <table id="variantsTable" class="table table-bordered table-hover">
      <thead>
        <tr>
          <th>Rank #</th>
          <th>Score</th>
          <th>Type</th>
          <th>Start loc</th>
          <th>Stop loc</th>
          <th>Length</th>
          <th>Region</th>
          <th>Function</th>
          <th>Frequency</th>
          <th>Gene(s)</th>
        </tr>
      </thead>
      <tbody>
        {% for variant in variants %}
          {{ variant_row(variant) }}
        {% else %}
          <tr>
              <td colspan="10">No matching variants</td>
          </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
  <div class="container-fluid">
    {{ pagination() }}
  </div>
{% endblock %}

{% macro pagination() %}
  <nav>
    <ul class="pager">
      {% if current_batch - per_page > 0 %}
        <li class="prev">
          <a href="{{ url_for('sv.variants', institute_id=institute_id, case_id=case_id, page=variants.next_num, skip=(skip - per_page), **query) }}">
            &larr; Prev
          </a>
        </li>
      {% endif %}
      {% if variants_count > current_batch %}
        <li class="next">
          <a href="{{ url_for('sv.variants', institute_id=institute_id, case_id=case_id, page=variants.next_num, skip=current_batch, **query) }}">
            Next &rarr;
          </a>
        </li>
      {% endif %}
    </ul>
  </nav>
{% endmacro %}

{% macro variant_row(variant) %}
  <tr>
    <td>
      <a href="{{ url_for('sv.variant', institute_id=institute_id,
                          case_id=case_id, variant_id=variant.id) }}">
        {{ variant.variant_rank }}
      </a>
    </td>
    <td>{{ variant.rank_score|int }}</td>
    <td>{{ variant.sub_category|upper }}</td>
    <td>{{ variant.position }}</td>
    <td>{{ 'inf' if variant.end == 100000000000 else variant.end }}</td>
    <td>{{ 'inf' if variant.length == 100000000000 else variant.length }}</td>
    <td>{{ variant.region_annotations[:3]|join(', ') }}</td>
    <td>{{ variant.functional_annotations[:3]|join(', ') }}</td>
    <td>{{ variant.thousand_genomes_frequency|human_decimal }}</td>
    <td>
      {% if variant.hgnc_symbols|length >= 5 %}
        {{ variant.hgnc_symbols[:2]|join(', ') }} [...] {{ variant.hgnc_symbols[-2:]|join(', ') }}
      {% else %}
        {{ variant.hgnc_symbols|join(', ') }}
      {% endif %}

      {% if variant.hgnc_symbols %}
        <span class="badge pull-right">{{ variant.hgnc_symbols|length }}</span>
      {% endif %}
    </td>
  </tr>
{% endmacro %}

{% block scripts %}
  {{ super() }}

  <script src="https://cdnjs.cloudflare.com/ajax/libs/sticky-table-headers/0.1.19/js/jquery.stickytableheaders.min.js"></script>

  <script>
    $(function () {
      $("#variantsTable").stickyTableHeaders({
        fixedOffset: $(".navbar-fixed-top")
      });
    })
  </script>
{% endblock %}
