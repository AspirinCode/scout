{% extends "layout.html" %}

{% block content_main %}
{{ dashboard_search_form() }}

<h1>Basic statistics</h1>
<div class="row">
  {% for group in analysis_types %}
    <div class="col-xs-3">
      <div class="panel panel-default">
        <div class="panel-heading">{{ group.name|capitalize }} samples (not cases)</div>
        <div class="panel-body">
          <h1 class="text-center">
            {{ group.count }}
          </h1>
        </div>
      </div>
    </div>
  {% endfor %}
</div>

<div class="row">
  {% for group in cases %}
    <div class="col-xs-4 col-md-2">
      <div class="panel panel-default">
        <div class="panel-heading">{{ group.status|capitalize }} Cases</div>
        <div class="panel-body">
          <h1 class="text-center {{ 'text-success' if group.status == 'solved' }}">
            {{ group.count }}
          </h1>
          <div class="text-center"><span class="text-muted">
            {{ (group.percent * 100)|round(1) }}%</span>
          </div>
        </div>
      </div>
    </div>
  {% endfor %}
</div>


<h1>Pedigree info</h1>
<div class="row">
  {% for topic in pedigree %}
    <div class="col-xs-4 col-md-2">
      <div class="panel panel-default">
        <div class="panel-heading">{{ topic.title }} Cases </div>
        <div class="panel-body">
          <h1 class="text-center">{{ topic.count }}</h1>
          <div class="text-center">
            <span class="text-muted">{{ (topic.percent * 100)|round(1) }}%</span>
          </div>
        </div>
      </div>
    </div>
  {% endfor %}
</div>


<h1>Cases with...</h1>
<div class="row">
  {% for topic in overview %}
    <div class="col-xs-4 col-md-3">
      <div class="panel panel-default">
        <div class="panel-heading">{{ topic.title }}</div>
        <div class="panel-body">
          <h1 class="text-center">{{ topic.count }}</h1>
          <div class="text-center">
            <span class="text-muted">{{ (topic.percent * 100)|round(1) }}%</span>
          </div>
        </div>
      </div>
    </div>
  {% endfor %}
</div>

<h1>Variants ...</h1>
<div class="row">
  {% for topic in variants %}
    <div class="col-xs-4 col-md-3">
      <div class="panel panel-default">
        <div class="panel-heading">{{ topic.title }}</div>
        <div class="panel-body">
          <h1 class="text-center">{{ topic.count }}</h1>
        </div>
        <div class="text-center"><span class="text-muted">
          {{ (topic.percent * 100)|round(1) }}%</span>
        </div>
      </div>
    </div>
  {% endfor %}
</div>
<div>
  <form id="dowload_var_stats" action="{{ url_for('variants.download_verified')}}" method="GET">
    <ol class="breadcrumb">
      <li><button type="submit" name="verified_vars" value="verified" class="btn btn-primary btn-xs">Download all verified variants for your cases</button></li>
    </ol>
  </form>
</div>
{% endblock %}

{% macro dashboard_search_form() %}
<form id='form' method='POST' action="{{ url_for('dashboard.index') }}" accept-charset="utf-8">
    <div class="row">
      <div class="col-md-8 col-xs-8">
        <div class="input-group">
          <span class="input-group-addon">
            <span class="glyphicon glyphicon-search"></span>
          </span>
          <input type="search" class="form-control" value="{{ query if query }}" name="query" id="query" placeholder="Enter query to filter cases summarized below" onchange="update_select({% if current_user.is_admin %}true{% else %}false{% endif %})"></input>
          </div>
      </div>
      <div class="col-md-2 col-xs-2">
      <select name="institute" id="institute" onchange="this.form.submit()">
        {% for inst in institutes %}
          {% if inst.display_name == 'All institutes' and query and not current_user.is_admin %}
            <option value="{{ inst._id }}" disabled>{{ inst.display_name }}</option>
          {% else %}
            <option value="{{ inst._id }}" {{ "selected" if inst._id == choice }} >{{ inst.display_name }}</option>
          {% endif %}
        {% endfor %}
      </select>
      </div>
      <div class="col-md-2 col-xs-2">
        <button type="submit" class="form-control">Search</input>
      </div>
    </div>
    <div class="bottom-align-text">
      <br>Examples: case_id=<strong>18201</strong>, HPO-term=<strong>HP:0001166</strong>, synopsis=<strong>synopsis:epilepsy</strong>, panel=<strong>panel:NMD</strong>, phenotype group=<strong>PG:0100022</strong>, cohort=<strong>cohort:pedhep</strong>.
    </div>
  </form>
{% endmacro %}

{% block scripts %}
  {{ super() }}
  <script type="text/javascript">
    function update_select(admin_user){
      var query_text = document.getElementById("query").value;
      var sel = document.getElementById("institute");
      if(query_text && !admin_user) {
        sel.children[0].disabled = "disabled";
        if(sel.options[0].selected) {
          sel.options[0].selected = false;
          sel.options[1].selected = true;
        }
      }
      else{
        sel.children[0].disabled = "";
      }
    }
  </script>
{% endblock %}
