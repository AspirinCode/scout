{% extends "layout.html" %}

{% block title %}
  {{ super() }} - {{ institute.display_name }} - {{ case.display_name }}
{% endblock %}

{% block top_nav %}
  {{ super() }}
  <li>
    <a href="{{ url_for('cases.index') }}">Institutes</a>
  </li>
  <li>
    <a href="{{ url_for('cases.cases', institute_id=institute._id) }}">
      {{ institute.display_name }}
    </a>
  </li>
  <li>
    <a href="{{ url_for('cases.case', institute_id=institute._id, case_name=case.display_name ) }}">
      {{ case.display_name }}
    </a>
  </li>
  <li class="active">
    <span class="navbar-text">MatchMaker</span>
  </li>
{% endblock %}

{% block content_main %}

<div class="panel panel-default">
  <div class="panel-body">
    <ol class="breadcrumb">
      <li>Submitted: <strong>{{case.mme_submission.created_at.strftime('%Y-%m-%d')}}</strong></li>
      <li>Last updated: <strong>{{case.mme_submission.updated_at.strftime('%Y-%m-%d')}}</strong></li>
    </ol>
    <div id="patientTab" class="container">
      <ul class="nav nav-tabs">
			<li class="active">
        <a  href="#1" data-toggle="tab">Patient Overview</a>
			</li>
			<li><a href="#2" data-toggle="tab">External Matches</a>
			</li>
			<li><a href="#3" data-toggle="tab">Internal Matches</a>
			</li>
		</ul>

			<div class="tab-content ">
			  <div class="tab-pane active" id="1">
          {{patient_data()}}
          {{search_nodes()}}
				</div>
				<div class="tab-pane" id="2">
          {{show_matches('external')}}
				</div>
        <div class="tab-pane" id="3">
          {{show_matches('internal')}}
				</div>
			</div>
    </div>
  </div>
</div>
{% endblock %}

{% macro patient_data() %}
<hr></hr>
<div>
  <p>Features (HPO terms):
    {% for hpo in case.mme_submission.features %}
      <span class="label label-primary">{{hpo.id}}</span>
    {% endfor %}
  </p>
  <p>Disorders (OMIM terms):
    {% for omim in case.mme_submission.disorders %}
      <span class="label label-info">{{omim.id}}</span>
    {% endfor %}
  </p>
  <p>Submitted patients:
    {% for patient in case.mme_submission.patients %}
      <ul>
        <li>Patient id: <strong>{{patient.id}}</strong></li>
        <li>Patient label: <strong>{{patient.label}}</strong></li>
        <li>Sex: <strong>{{patient.sex}}</strong></li>
        <li>genomic features:
          <div class="row">
            {% for g_feat in patient.genomicFeatures %}
              <div class="col-xs-6 col-md-3">
                <div class="thumbnail">
                  <div class="caption">
                    {% for key, value in g_feat.items() %}
                        {% if key == 'gene' %}
                          <h3>gene: {{value.id}}</h3>
                        {% elif key == 'variant' %}
                          {{key}}:<br>
                          {% for ikey, item in value.items() %}
                            {{ikey}}:<strong>{{item}}</strong><br>
                          {% endfor %}
                        {% else %} <!-- this will be zygosity -->
                          {{key}}:<strong>{{value}}</strong>
                        {% endif %}
                    {% endfor %}
                  </div>
                </div>
              </div>
            {% endfor %}
          </div>
        </li>
      </ul>
    {% endfor %}
  </p>
</div>
{% endmacro %}

{% macro search_nodes() %}
<hr>
<form action="{{ url_for('cases.matchmaker_matches', institute_id=institute._id, case_name=case.display_name) }}" method="POST">
  <p><h4>Search for similar patients
  <select id="nodes" name="nodes">
    <option value="external" selected>Search all nodes</option>
    {% for node in nodes %}
      <option value="{{node.id}}">{{node.description}} (specific node)</option>
    {% endfor %}
    <option value="internal">Limit search to other scout patients</option>
  </select>
  <button type="submit" class="btn btn-primary">Submit</button>
  </h4>
  </p>
</form>
{% endmacro %}

{% macro show_matches(type) %}
<!-- show matches of the selected type from the most recent -->
<hr></hr>
  {% for patient, match_objs in matches.items() %}
    {% set p_name = patient.split('.') %}
    <h4>Patient {{ p_name[1] }}</h4>
    <table class="table table-striped">
      <thead>
        <tr>
          <th scope="col">Patient ID</th>
          <th scope="col">MME node</th>
          <th scope="col">Score</th>
          <th scope="col">Match date</th>
          <th scope="col">Contact</th>
          <th scope="col">Features</th>
          <th scope="col">Diagnoses</th>
          <th scope="col">Genomic Features</th>
        </tr>
      </thead>
      <tbody>
      {% for match_obj in match_objs%}
        {% if match_obj.match_type == type %}
          <tr>
            <td>{{match_obj.patient_id}}</td>
            <td>{{match_obj.node.label}}</td>
            <td><span class="badge badge-primary badge-pill">{{match_obj.score.patient|round(4)}}</badge></td>
            <td>{{match_obj.match_date.strftime('%Y-%m-%d')}}</td>
            <td>{{match_obj.patient.contact.name}}
              {% if match_obj.patient.contact.institution %}
                <br>{{match_obj.patient.contact.institution}}
              {% endif %}
              <br>{{match_obj.patient.contact.href}}
            </td>
            <td>
              {% for feature in match_obj.patient.features %}
                <span data-toggle="tooltip" title="{{feature.label or 'description not available'}}" class="label label-primary">{{feature.label}}({{feature.id}})</span>
              {% endfor %}
            </td>
            <td>
              {% for omim in match_obj.patient.disorders %}
                <span data-toggle="tooltip" title="{{omim.label or 'description not available'}}" class="label label-info">{{omim.id}}</span>
              {% endfor %}
            </td>
            <td>
              {% for g_feat in match_obj.patient.genomicFeatures %}
              <ul>
              {% for key, value in g_feat.items() %}
                <li>
                {% if key == 'gene' %}
                  {{key}}:&nbsp;<span class="label label-default">{{value.id}}</span>
                {% elif key == 'variant' %}
                  {{key}}:<br>
                  {% for ikey, item in value.items() %}
                    {{ikey}}:<strong>{{item}}</strong><br>
                  {% endfor %}
                {% elif key == 'type' %} <!-- this will be variant effect -->
                  {{key}}:<strong>{{value.label}}</strong>
                {% else %} <!-- this will be zygosity -->
                  {{key}}:<strong>{{value}}</strong>
                {% endif %}
                </li>
              {% endfor %}
              </ul>
              <hr>
              {% endfor %}
            </td>
          </tr>
        {% endif %}
      {% endfor %}
      </tbody>
    </table>
  {% endfor %}
{% endmacro %}

{% block scripts %}
  {{ super() }}
  <script>
  $(function () {
    $('[data-toggle="tooltip"]').tooltip();
  };
  </script>
{% endblock %}
